# 系统设计方案：能耗预测与异常检测服务

本文档详细描述了将现有的时间序列分析项目，转化为一套可运营、可集成的API服务的完整设计方案。

## 1. 核心思路：解耦与服务化

系统将构建为一个解耦的、服务化的架构，主要由以下三个独立部分组成：

1.  **核心预测服务 (ML Service)**：一个独立的、无状态的API服务。它加载训练好的模型，接收来自物联网平台的数据，并返回预测或异常检测结果。
2.  **后台管理系统 (Admin System)**：一个带有Web前端的后台，负责模型管理、触发模型训练、数据可视化和API密钥管理。
3.  **模型训练服务 (Training Worker)**：一个独立的、异步的后台任务，负责执行耗时的模型训练，并将训练产物存入模型库。

### 1.1 系统架构图

```
+-----------------+      /predict        +----------------------+
|                 |--------------------->|                      |
|  物联网平台      |      /detect         |  核心预测服务 (API)   |
| (IoT Platform)  |<---------------------|                      |
|                 |      (JSON)          +----------------------+
+-----------------+                            | (加载模型)
      |                                        |
(调用训练API)                                    |
      |                      +---------------------+----------------------+
      v                      |                                           |
+-----------------+      |  后台管理系统 (Admin System)                 |
|  MinIO/S3       |<---->|                                           |
| (存储CSV数据)   |      |  [前端] React/Vue -> [后端] FastAPI/Django |
+-----------------+      +-------------------------------------------+
      ^                      | (触发训练)
      | (下载数据)             |
      |                      v
+----------------------+     +-----------------+
|                      |     |                 |
|  模型训练服务         |<----+  任务队列 (Redis) |
| (Training Worker)    |     |                 |
|                      |     +-----------------+
+----------------------+
      |
      v
+-----------------+
|                 |
|  模型文件存储    |
| (Model Store)   |
+-----------------+
```

### 1.2 自动化训练数据流

1.  **触发训练**：物联网平台生成包含产线/车间历史数据的 `.csv` 文件，并上传到 MinIO。
2.  **发送通知**：平台调用后台系统的 `POST /api/v1/training-jobs` 端点，请求体中包含资产ID (`asset_id`) 和CSV文件的下载链接 (`data_url`)。
3.  **任务入队**：后台系统接收到请求，将训练任务（包含`asset_id`和`data_url`）放入 Celery 任务队列，并立即返回“任务已接收”的响应。
4.  **执行训练**：模型训练服务从队列中获取任务，下载数据，执行训练，并将新模型保存到模型库，最后更新数据库中的模型记录。

## 2. API 接口设计

**基础URL**: `https://your-domain.com/api/v1`
**认证方式**: HTTP请求头 `Authorization: Bearer <YOUR_API_KEY>`

### 端点1：能耗预测

-   **Endpoint**: `POST /assets/{asset_id}/predict`
-   **描述**: 针对指定的资产（产线/车间），预测未来能耗。
-   **URL参数**:
    -   `asset_id` (string, required): 产线或车间的唯一标识符。
-   **请求体**:
    ```json
    {
      "historical_data": [
        {"timestamp": "2025-07-03T10:00:00Z", "value": 120.5, "temp": 25.1, "production": 500},
        {"timestamp": "2025-07-03T11:00:00Z", "value": 122.1, "temp": 25.3, "production": 510}
      ],
      "forecast_horizon": 24
    }
    ```
-   **响应体**:
    ```json
    {
      "asset_id": "production_line_A",
      "forecast_data": [
        {"timestamp": "2025-07-04T12:00:00Z", "predicted_value": 125.0}
      ]
    }
    ```

### 端点2：异常检测

-   **Endpoint**: `POST /assets/{asset_id}/detect_anomalies`
-   **描述**: 针对指定的资产，分析其数据流中的异常点。
-   **URL参数**:
    -   `asset_id` (string, required): 产线或车间的唯一标识符。
-   **请求体**:
    ```json
    {
      "data_stream": [
        {"timestamp": "2025-07-03T10:00:00Z", "value": 120.5, "temp": 25.1, "production": 500}
      ]
    }
    ```
-   **响应体**:
    ```json
    {
      "asset_id": "production_line_A",
      "anomalies": [
        {"timestamp": "2025-07-03T11:00:00Z", "value": 180.0, "reason": "Exceeds predicted value by 45%"}
      ]
    }
    ```

## 3. 技术选型

-   **后端语言**: **Python 3.9+** (复用现有代码)
-   **API框架**: **FastAPI** (高性能, 自动生成API文档)
-   **后台管理（前端）**: **React** 或 **Vue.js** (现代、高效, 生态丰富)
-   **数据库**: **PostgreSQL** (稳定、可靠)
-   **异步任务队列**: **Celery** + **Redis** (处理耗时训练任务)
-   **部署**: **Docker** + **Docker Compose** (环境隔离, 简化部署)

## 4. 性能要求评估 (< 500ms)

为达到500ms内的响应目标，需采取以下策略：

1.  **模型预加载与缓存**: API服务启动时，将生产模型加载到内存中缓存，避免每次请求都从磁盘读取。
2.  **优化的数据预处理**: 高效地将请求的JSON数据转换为模型所需的格式。
3.  **模型选择的权衡**: 在后台为不同资产配置不同模型，可在速度（LightGBM, TiDE）和精度（TFT, LSTM）间权衡。
4.  **硬件资源**: 为API服务提供足够的CPU性能，或为深度学习模型配备GPU。

## 5. 实施路线图

1.  **第一阶段：API服务 MVP**
    -   使用FastAPI搭建API服务，实现核心预测端点。
    -   硬编码一个现有模型进行快速验证。
    -   *目标*：让物联网平台能立即开始调用API。

2.  **第二阶段：后台系统与模型管理**
    -   开发后台，实现模型的增删改查和API密钥管理。
    -   改造API服务，使其能从数据库动态加载指定的“活跃”模型。

3.  **第三阶段：异步训练与系统完善**
    -   集成Celery和Redis，构建异步训练服务。
    -   在后台加入“触发训练”的功能。
    -   完善前端，增加数据可视化图表。

4.  **第四阶段：部署与优化**
    -   编写Dockerfile和Docker Compose配置，实现容器化部署。
    -   进行压力测试，完善日志、监控和告警。

## 6. 后续展望

当前系统已是一个功能完整的原型，但仍有许多可以扩展和优化的方向，以使其更健壮、更易用、更符合生产环境需求：

*   **API 密钥的哈希存储**：在 `admin_api.py` 中实现真正的密钥哈希和验证（例如使用 `bcrypt`），而不是直接存储明文或 UUID。
*   **更完善的错误处理和日志记录**：在生产环境中，需要更健壮的错误捕获、统一的日志格式和日志聚合方案（如 ELK Stack 或 Grafana Loki）。
*   **模型版本管理和回滚**：在后台管理系统中增加更精细的模型版本控制功能，包括查看历史版本、比较模型性能、以及快速回滚到旧版本的能力。
*   **训练任务状态追踪**：在前端 UI 中实时显示 Celery 任务的状态（例如：排队中、进行中、成功、失败），并提供任务日志查看功能。
*   **数据可视化**：在后台管理系统中集成更丰富的图表，直观展示历史数据、预测结果、异常点以及模型性能指标。
*   **异常检测 API ��完整实现**：目前预测 API 已完成，异常检测 API (`/assets/{asset_id}/detect_anomalies`) 还需要在 `api_server/main.py` 中实现其核心逻辑，包括加载 `QuantileDetector` 并应用到实时数据流。
*   **部署自动化与容器化**：编写完整的 `Dockerfile` 和 `docker-compose.yml` 文件，实现整个系统的容器化部署，简化环境配置和扩展。
*   **监控与告警**：集成 Prometheus/Grafana 等工具，对 API 服务的性能、模型推理延迟、Celery 任务队列状态等进行实时监控和告警。
*   **多模型支持**：在训练任务中支持训练和管理多种模型类型（TFT, LSTM, TiDE），并允许管理员选择为特定资产部署哪种模型。
*   **数据输入验证与清洗**：对物联网平台传入的原始数据进行更严格的验证和清洗，确保数据质量。
*   **用户认证与权限管理**：为后台管理系统添加用户登录、角色和权限管理功能。
